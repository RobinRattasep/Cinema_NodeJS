<!DOCTYPE html>
<html>
<head>
    <title>Cinema Movie Listings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.js"></script>
</head>
<body>
<form id="login-form">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username">
    <label for="password">Password:</label>
    <input type="password" id="password" name="password">
    <input type="submit" value="Log In">
</form>


<form id="add-movie-form">
    <label for="title">Movie Title:</label>
    <input type="text" name="title" id="title-input">
    <br>
    <label for="showtimes">Movie Showtimes (comma separated):</label>
    <input type="text" name="showtimes" id="showtimes-input">
    <br>
    <input type="submit" value="Add Movie">
</form>

<h1>Cinema Movie Listings</h1>
<ul id="movie-list"></ul>
<form id="book-form">
    <label for="movie">Select a movie to book:</label>
    <select name="movie" id="movie-options"></select>
    <label for="showtime">Select a showtime to book:</label>
    <select name="showtime" id="showtime-options"></select>
    <label for="seat">Select a seat to book:</label>
    <select name="seat" id="seat-options"></select>
    <input type="submit" value="Book Movie">
</form>

<script>
    const movieOptions = document.getElementById("movie-options");
    const socket = io();

    // Listen for the newMovie event
    socket.on('newMovie', (movie) => {
        const option = document.createElement("option");
        option.innerHTML = movie.title;
        movieOptions.appendChild(option);
        const showtimes = movie.showtimes.split(',');
        // Add the new movie to the list
        const movieList = document.getElementById("movie-list");
        const newMovie = document.createElement("li");
        newMovie.innerHTML = `${movie.title} - ${showtimes.join(', ')}`;
        movieList.appendChild(newMovie);
    });
</script>
<script>



    function saveMoviesToLocalStorage(movie) {
        // Retrieve the current list of movies from localStorage
        let movies = JSON.parse(localStorage.getItem("movies")) || [];
        // Push the new movie to the list
        movies.push(movie);
        // Set the updated list back to localStorage
        localStorage.setItem("movies", JSON.stringify(movies));
    }



    function renderMovies(movies) {
        // Clear any existing movie elements
        const movieList = document.getElementById("movie-list");
        movieList.innerHTML = "";

        // Iterate through the movies list
        for (let i = 0; i < movies.length; i++) {
            // Create a new movie element
            const movieElement = document.createElement("li");
            movieElement.innerHTML = `${movies[i].title} - ${movies[i].showtimes.join(", ")}`;
            movieList.appendChild(movieElement);
        }
    }




    const loginForm = document.getElementById("login-form");

    loginForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        fetch('/login', {
            method: 'POST',
            body: JSON.stringify({ username: username, password: password }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                } else {
                    alert(data.error);
                }
            });
    });




    const addMovieForm = document.getElementById("add-movie-form");
    addMovieForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const title = document.getElementById("title-input").value;
        const showtimes = document.getElementById("showtimes-input").value;
        fetch('/add-movie', {
            method: 'POST',
            body: JSON.stringify({ title, showtimes }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(() => {
                // Handle the response from the server
                    let movies = JSON.parse(localStorage.getItem("movies")) || [];

                    //console.log(movies)
                    var movie1 = (JSON.stringify({ title, showtimes }))
                    var movie = JSON.parse(movie1)
                    // Push the new movie to the list
                    movies.push(movie);
                    // Set the updated list back to localStorage
                    localStorage.setItem("movies", JSON.stringify(movies));
                    alert(`Successfully added movie ${title} with showtimes ${showtimes}`);
                    //saveMoviesToLocalStorage(response.json);
            })
            .catch(error => {
                // Handle any errors that occur during the request
                console.error(error);
                alert("An error occurred while adding the movie. Please try again later.");
            });
    });



    const showtimeOptions = document.getElementById("showtime-options");
    const seatOptions = document.getElementById("seat-options");
    const bookForm = document.getElementById("book-form");

    fetch('/movies')
        .then(response => {
            if (response.ok) {
                response.json().then(servermovies => {
                    let movies;
                    if (localStorage.length !== 0) {
                        movies = JSON.parse(localStorage.getItem("movies"));
                    } else {
                        fetch('/movies')
                            .then(response => {
                                if (response.ok) {
                                    response.json().then(data => {
                                        movies = data;
                                        localStorage.setItem("movies", JSON.stringify(movies));
                                    });
                                } else {
                                    movies = serverMovies;
                                    console.log("Response is not OK");
                                }
                            })
                            .catch(error => {
                                console.error(error);
                            });
                    }
// create options for the dropdown using movies from localStorage
                    movies.forEach(movie => {





                        // create movie options
                        const option = document.createElement("option");
                        option.value = movie.title;
                        option.innerHTML = movie.title;
                        movieOptions.appendChild(option);





                        // create showtime options
                        movie.showtimes.forEach(showtime => {
                            const showtimeOption = document.createElement("option");
                            showtimeOption.value = showtime;
                            showtimeOption.innerHTML = showtime;
                            showtimeOptions.appendChild(showtimeOption);
                        });
                        // create seat options
                        for (let i = 1; i <= 100; i++) {
                            const seatOption = document.createElement("option");
                            seatOption.value = i;
                            seatOption.innerHTML = i;
                            seatOptions.appendChild(seatOption);
                        }
                    });


                });
            } else {
                console.log("Response is not OK");
            }
        })
        .catch(error => {
            console.error(error);
        });



    bookForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const selectedMovie = movieOptions.value;
        const selectedShowtime = showtimeOptions.value;
        const selectedSeat = seatOptions.value;

        // Validate that all fields are selected
        if(!selectedMovie || !selectedShowtime || !selectedSeat) {
            alert("Please select a movie, showtime, and seat.");
            return;
        }

        // Send a POST request to the server to book the ticket
        fetch('/book', {
            method: 'POST',
            body: JSON.stringify({ movie: selectedMovie, showtime: selectedShowtime, seat: selectedSeat }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                // Handle the response from the server
                if(success) {
                    alert("You have booked a ticket for " + selectedMovie + " at " + selectedShowtime + " seat " + selectedSeat);
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                // Handle any errors that occur during the request
                console.error(error);
                alert("An error occurred while booking your ticket. Please try again later.");
            });
    });


    setTimeout(() => {
        // Make a GET request to the backend to retrieve the updated movies array
        fetch('/movies')
            .then(response => response.json())
            .then(movies => {
                // Update the localStorage with the updated movies array
                localStorage.setItem("movies", JSON.stringify(movies));
                const movieOptions = document.getElementById("movie-options");
                movieOptions.innerHTML = '';

                movies.forEach(movie => {





                    // create movie options
                    const option = document.createElement("option");
                    option.value = movie.title;
                    option.innerHTML = movie.title;
                    movieOptions.appendChild(option);





                    // create showtime options
                    movie.showtimes.forEach(showtime => {
                        const showtimeOption = document.createElement("option");
                        showtimeOption.value = showtime;
                        showtimeOption.innerHTML = showtime;
                        showtimeOptions.appendChild(showtimeOption);
                    });
                    // create seat options
                    for (let i = 1; i <= 100; i++) {
                        const seatOption = document.createElement("option");
                        seatOption.value = i;
                        seatOption.innerHTML = i;
                        seatOptions.appendChild(seatOption);
                    }
                });
            })
            .catch(error => {
                console.error(error);
            });
    }, 5000);


</script>
</body>
</html>
